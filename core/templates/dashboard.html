<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Welcome, {{ user.username }}</h3>
        <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>

    <!-- CREATE APPROVAL -->
    <div class="mb-3">
        <a href="{% url 'create_approval' %}" class="btn btn-primary">
            âž• Create Approval
        </a>
    </div>

    <!-- SLA DASHBOARD -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-success text-center">
                    <h6>ðŸŸ¢ Pending &lt; 24 hrs</h6>
                    <h3>{{ sla_green|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning">
                <div class="card-body text-warning text-center">
                    <h6>ðŸŸ¡ Pending 24â€“48 hrs</h6>
                    <h3>{{ sla_yellow|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-danger">
                <div class="card-body text-danger text-center">
                    <h6>ðŸ”´ Pending &gt; 48 hrs</h6>
                    <h3>{{ sla_red|length }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================= -->
    <!-- ASSIGNED TO ME -->
    <!-- ========================= -->
    <h4>Approvals Assigned to Me</h4>

    {% if assigned_tasks %}
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Requester</th>
                <th>Urgency</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for task in assigned_tasks %}
            <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.requester.username }}</td>
                <td>
                    <span class="badge 
                    {% if task.urgency == 'CRITICAL' %}bg-danger
                    {% elif task.urgency == 'HIGH' %}bg-warning
                    {% else %}bg-secondary{% endif %}">
                        {{ task.urgency }}
                    </span>
                </td>
                <td>
                    <!-- APPROVE -->
                    <form method="POST" action="/approve/{{ task.id }}/" class="mb-1">
                        {% csrf_token %}
                        <input type="text" name="comment" class="form-control form-control-sm mb-1"
                               placeholder="Approval comment (optional)">
                        <button class="btn btn-success btn-sm w-100">Approve</button>
                    </form>

                    <!-- REJECT -->
                    <form method="POST" action="/reject/{{ task.id }}/" class="mb-1">
                        {% csrf_token %}
                        <input type="text" name="comment" class="form-control form-control-sm mb-1"
                               placeholder="Rejection reason (required)">
                        <button class="btn btn-danger btn-sm w-100">Reject</button>
                    </form>

                    <a href="/audit/{{ task.id }}/" class="btn btn-info btn-sm w-100">Audit</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">No approvals assigned to you.</p>
    {% endif %}

    <hr>

    <!-- ========================= -->
    <!-- CREATED BY ME -->
    <!-- ========================= -->
    <h4>Approvals Created by Me</h4>

    {% if created_tasks %}
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Approver</th>
                <th>Status</th>
                <th>Audit</th>
            </tr>
        </thead>
        <tbody>
            {% for task in created_tasks %}
            <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.approver.username }}</td>
                <td>
                    <span class="badge 
                    {% if task.status == 'APPROVED' %}bg-success
                    {% elif task.status == 'REJECTED' %}bg-danger
                    {% else %}bg-warning{% endif %}">
                        {{ task.status }}
                    </span>
                </td>
                <td>
                    <a href="/audit/{{ task.id }}/" class="btn btn-outline-info btn-sm">
                        View Timeline
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">You havenâ€™t created any approvals yet.</p>
    {% endif %}

</div>

</body>
</html>
